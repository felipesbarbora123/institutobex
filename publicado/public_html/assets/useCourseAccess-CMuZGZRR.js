import{m as A,r as o,s as g}from"./index-DZwxJa6p.js";const m="userCoursesCache",E="course_access_",_=5*60*1e3,J=s=>{const{user:r}=A(),[$,n]=o.useState(!1),[w,u]=o.useState(!0),[O,l]=o.useState([]),[b,f]=o.useState(!1),C=o.useCallback(e=>{try{const t=`${E}${e}`,a=localStorage.getItem(t);if(!a)return!1;const c=JSON.parse(a),v=new Date(c.dataCompra);return(new Date().getTime()-v.getTime())/(1e3*60*60*24)>30?(localStorage.removeItem(t),!1):c.cursoLiberado&&c.cursoId===e}catch{return!1}},[]),D=o.useCallback((e,t)=>{try{const a=`${E}${e}`,c={cursoLiberado:!0,cursoId:e,dataCompra:new Date().toISOString(),userId:t};localStorage.setItem(a,JSON.stringify(c)),console.log(`ðŸ’¾ [${new Date().toISOString()}] Acesso otimista salvo para curso ${e}`)}catch(a){console.error("Erro ao salvar acesso otimista:",a)}},[]),h=o.useCallback(()=>{try{const e=localStorage.getItem(m);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>_?(localStorage.removeItem(m),null):t.enrollments}catch{return null}},[]),d=o.useCallback(e=>{try{const t={enrollments:e,timestamp:Date.now()};localStorage.setItem(m,JSON.stringify(t))}catch(t){console.error("Error saving cache:",t)}},[]),y=o.useCallback(()=>{localStorage.removeItem(m)},[]),i=o.useCallback(async()=>{if(!r)return[];try{const{data:e,error:t}=await g.from("course_enrollments").select("course_id").eq("user_id",r.id);if(t)throw t;const a=(e==null?void 0:e.map(c=>c.course_id))||[];return d(a),a}catch(e){return console.error("Error fetching enrollments:",e),[]}},[r,d]),p=o.useCallback(async()=>{if(!r){n(!1),l([]),u(!1),f(!0);return}if(f(!1),s&&C(s)){console.log(`âš¡ [${new Date().toISOString()}] Acesso otimista encontrado para curso ${s}`),n(!0),u(!1),f(!0),i().then(a=>{l(a),a.includes(s)?(console.log(`âœ… [${new Date().toISOString()}] Curso ${s} confirmado no servidor`),n(!0)):console.log(`âš ï¸ [${new Date().toISOString()}] Curso ${s} nÃ£o estÃ¡ no servidor ainda, mantendo acesso otimista`)});return}u(!0);const e=h();if(e){l(e),s&&n(e.includes(s)),u(!1);const t=await i();l(t),s&&n(t.includes(s)),f(!0)}else{const t=await i();l(t),s&&n(t.includes(s)),u(!1),f(!0)}},[r,s,h,i,C]),S=o.useCallback(async()=>{if(!r)return;console.log(`ðŸ”„ [${new Date().toISOString()}] refreshCache chamado para usuÃ¡rio ${r.id}`);const e=await i();if(l(e),s){const t=e.includes(s);console.log(`ðŸ“Š [${new Date().toISOString()}] Curso ${s} estÃ¡ matriculado? ${t}`),n(t)}},[r,s,i]);return o.useEffect(()=>{p()},[p]),o.useEffect(()=>{if(!r)return;const e=g.channel(`enrollments-${r.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"course_enrollments",filter:`user_id=eq.${r.id}`},()=>{S()}).subscribe();return()=>{g.removeChannel(e)}},[r,S]),{isEnrolled:$,isLoading:w,verificationComplete:b,enrolledCourses:O,refreshCache:S,clearCache:y,saveOptimisticAccess:D,checkOptimisticAccess:C}};export{J as u};
