import{c as K,j as e,B as p,i as G,o as J,u as Q,m as X,n as Y,r as f,s as d}from"./index-DZwxJa6p.js";import{H as w,i as Z,F as ee}from"./Footer-C1KMTEGG.js";import{C as I,b as q,c as $,d as se,a as re}from"./card-BXzsGqNW.js";import{S as ae}from"./scroll-area-RY6zaaOo.js";import{P as te,C as oe}from"./progress-B-3pGF9K.js";import{C as M}from"./circle-check-ByrmEm5X.js";import{D as ie}from"./download-CPOnxjoA.js";import"./input-DDQYHuv2.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=K("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),ne=({videoUrl:t,title:l})=>{const o=(r=>{const n=r.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/);if(n)return`https://www.youtube.com/embed/${n[1]}`;const i=r.match(/vimeo\.com\/(\d+)/);return i?`https://player.vimeo.com/video/${i[1]}`:(r.includes("embed"),r)})(t),c=o.endsWith(".mp4")||o.endsWith(".webm");return e.jsx("div",{className:"aspect-video w-full bg-black rounded-lg overflow-hidden",children:c?e.jsxs("video",{controls:!0,className:"w-full h-full",title:l,children:[e.jsx("source",{src:o,type:"video/mp4"}),"Seu navegador n√£o suporta a reprodu√ß√£o de v√≠deos."]}):e.jsx("iframe",{src:o,title:l,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,className:"w-full h-full"})})},ce=({lessons:t,currentLessonId:l,courseId:x,onLessonClick:o})=>{const c=t.filter(n=>n.completed).length,r=t.length>0?Math.round(c/t.length*100):0;return e.jsxs("div",{className:"border rounded-lg bg-card",children:[e.jsxs("div",{className:"p-4 border-b space-y-3",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Conte√∫do do Curso"}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:[c," de ",t.length," aulas conclu√≠das"]}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:[r,"%"]})]}),e.jsx(te,{value:r,className:"h-2"})]})]}),e.jsx(ae,{className:"h-[600px]",children:e.jsx("div",{className:"p-2",children:t.map(n=>{const i=n.id===l;return e.jsx(p,{variant:i?"secondary":"ghost",className:G("w-full justify-start text-left h-auto py-3 px-3 mb-1",i&&"bg-primary/10"),onClick:()=>o(n.id),children:e.jsxs("div",{className:"flex items-start gap-3 w-full",children:[e.jsx("div",{className:"mt-1 flex-shrink-0",children:n.completed?e.jsx(M,{className:"w-5 h-5 text-green-500"}):i?e.jsx(oe,{className:"w-5 h-5 text-primary"}):e.jsx("div",{className:"w-5 h-5 rounded-full border-2 border-muted-foreground/30"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"font-medium text-sm line-clamp-2",children:[n.order_number,". ",n.title]}),n.duration_minutes>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[n.duration_minutes," min"]})]})]})},n.id)})})})]})},je=()=>{const{courseId:t,lessonId:l}=J(),x=Q(),{user:o}=X(),{toast:c}=Y(),[r,n]=f.useState(null),[i,_]=f.useState([]),[y,T]=f.useState([]),[v,j]=f.useState(!1),[z,C]=f.useState(!0),[le,h]=f.useState(null);f.useEffect(()=>{t&&l&&o&&F()},[t,l,o]);const F=async()=>{if(!(!o||!t))try{const{data:s,error:a}=await d.from("course_enrollments").select("id").eq("user_id",o.id).eq("course_id",t).maybeSingle();if(a){console.error("‚ùå Erro ao verificar matr√≠cula:",a),h(!1);return}if(!s){c({title:"Acesso negado",description:"Voc√™ precisa estar matriculado neste curso para acessar as aulas.",variant:"destructive"}),h(!1),x(`/curso/${t}`);return}h(!0),E(),V()}catch(s){console.error("‚ùå Erro ao verificar matr√≠cula:",s),h(!1)}},E=async()=>{try{C(!0);const{data:s,error:a}=await d.from("lessons").select("*").eq("course_id",t).order("order_number",{ascending:!0});if(a)throw console.error("‚ùå Erro ao carregar aulas:",a),a;if(!s||s.length===0){console.warn("‚ö†Ô∏è Nenhuma aula encontrada para o curso"),_([]);return}const{data:u,error:L}=await d.from("lesson_progress").select("lesson_id, completed").eq("user_id",o.id).in("lesson_id",s.map(m=>m.id));L&&console.error("‚ùå Erro ao carregar progresso:",L);const W=new Map((u==null?void 0:u.map(m=>[m.lesson_id,m.completed]))||[]),S=s.map(m=>({...m,completed:W.get(m.id)||!1}));_(S);const N=S.find(m=>m.id===l);N?(n(N),j(N.completed||!1)):console.warn("‚ö†Ô∏è Aula atual n√£o encontrada:",l);const{data:g,error:A}=await d.from("course_materials").select("*").or(`lesson_id.eq.${l},course_id.eq.${t}`);A?console.error("‚ùå Erro ao carregar materiais:",A):(console.log("üìö Materiais carregados:",(g==null?void 0:g.length)||0),T(g||[]))}catch(s){console.error("‚ùå Erro fatal ao carregar aula:",s),c({title:"Erro ao carregar aula",description:s.message||"Ocorreu um erro inesperado. Tente novamente.",variant:"destructive"}),n(null)}finally{C(!1)}},V=async()=>{if(!(!o||!t))try{const{data:s,error:a}=await d.from("course_enrollments").update({last_accessed:new Date().toISOString()}).eq("user_id",o.id).eq("course_id",t);if(a){console.error("‚ùå Erro ao atualizar last_accessed:",a);return}console.log("‚úÖ Last accessed atualizado:",s)}catch(s){console.error("‚ùå Exce√ß√£o ao atualizar last_accessed:",s)}},B=async()=>{if(!(!o||!r))try{if(v)await d.from("lesson_progress").delete().eq("user_id",o.id).eq("lesson_id",r.id),j(!1),c({title:"Aula desmarcada como conclu√≠da"});else if(await d.from("lesson_progress").upsert({user_id:o.id,lesson_id:r.id,completed:!0,completed_at:new Date().toISOString()}),j(!0),i.filter(a=>a.completed||a.id===r.id).length===i.length){c({title:"Parab√©ns! üéâ",description:"Voc√™ concluiu o curso! Seu certificado est√° dispon√≠vel.",duration:5e3});try{const{data:a}=await d.from("profiles").select("first_name, last_name").eq("id",o.id).single(),{data:u}=await d.from("courses").select("title").eq("id",t).single();await d.functions.invoke("trigger-webhook",{body:{eventType:"curso_concluido",payload:{evento:"curso_concluido",usuario:a?`${a.first_name} ${a.last_name}`:o.email||"",curso:(u==null?void 0:u.title)||"",certificado_gerado:!0}}})}catch(a){console.error("Erro ao disparar webhook:",a)}setTimeout(()=>{x(`/curso/${t}`)},3e3)}else c({title:"Aula conclu√≠da! üéâ"});E()}catch(s){c({title:"Erro ao atualizar progresso",description:s.message,variant:"destructive"})}},b=s=>{x(`/curso/${t}/aula/${s}`)},U=()=>{if(!r)return;const s=i.findIndex(a=>a.id===r.id);s>0&&b(i[s-1].id)},D=()=>{if(!r)return;const s=i.findIndex(a=>a.id===r.id);s<i.length-1&&b(i[s+1].id)},H=s=>s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":(s/(1024*1024)).toFixed(2)+" MB";if(z)return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(w,{}),e.jsx("div",{className:"container mx-auto px-4 py-20 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Carregando aula..."})})]});if(!r)return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(w,{}),e.jsxs("div",{className:"container mx-auto px-4 py-20 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Aula n√£o encontrada"}),e.jsx(p,{onClick:()=>x(`/curso/${t}`),children:"Voltar ao Curso"})]})]});const k=i.findIndex(s=>s.id===r.id),O=k>0,R=k<i.length-1;return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(w,{}),e.jsxs("main",{className:"container mx-auto px-4 py-8",children:[e.jsxs(p,{variant:"ghost",onClick:()=>x(`/curso/${t}`),className:"mb-4",children:[e.jsx(P,{className:"w-4 h-4 mr-1"}),"Voltar ao Curso"]}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[r.video_url&&e.jsx(ne,{videoUrl:r.video_url,title:r.title}),e.jsx(I,{children:e.jsx(q,{children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs($,{className:"text-2xl mb-2",children:["Aula ",r.order_number,": ",r.title]}),r.description&&e.jsx(se,{className:"text-base",children:r.description})]}),e.jsxs(p,{variant:v?"outline":"default",onClick:B,className:"flex-shrink-0",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),v?"Conclu√≠da":"Marcar como Conclu√≠da"]})]})})}),y.length>0&&e.jsxs(I,{children:[e.jsx(q,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-5 h-5"}),"Materiais desta Aula"]})}),e.jsx(re,{className:"space-y-3",children:y.map(s=>{var a;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(a=s.file_type)==null?void 0:a.toUpperCase()," ‚Ä¢ ",H(s.file_size)]})]}),e.jsx(p,{variant:"outline",size:"sm",onClick:()=>{if(!s.file_url){c({title:"Erro",description:"URL do material n√£o dispon√≠vel",variant:"destructive"});return}try{window.open(s.file_url,"_blank","noopener,noreferrer")}catch(u){console.error("Erro ao abrir material:",u),c({title:"Erro ao abrir material",description:"N√£o foi poss√≠vel abrir o material. Tente novamente.",variant:"destructive"})}},children:"Baixar"})]},s.id)})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(p,{variant:"outline",onClick:U,disabled:!O,children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),"Aula Anterior"]}),e.jsxs(p,{variant:"outline",onClick:D,disabled:!R,children:["Pr√≥xima Aula",e.jsx(Z,{className:"w-4 h-4 ml-2"})]})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(ce,{lessons:i,currentLessonId:r.id,courseId:t,onLessonClick:b})})]})]}),e.jsx(ee,{})]})};export{je as default};
