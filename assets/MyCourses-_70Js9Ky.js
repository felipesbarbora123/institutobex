import{r as x,m as S,u as R,s as c,k as y,j as e,L as A,B as g}from"./index-DZwxJa6p.js";import{H as C,F as w,B as $}from"./Footer-C1KMTEGG.js";import{C as T}from"./card-BXzsGqNW.js";import{P as F,C as V}from"./progress-B-3pGF9K.js";import{R as z}from"./ReconcilePayments-BTwTWyql.js";import{C as H}from"./circle-check-ByrmEm5X.js";import{C as O}from"./clock-oaySqPQl.js";import"./input-DDQYHuv2.js";import"./refresh-cw-GX1sFyo7.js";const Z=()=>{const[f,_]=x.useState([]),[k,p]=x.useState(!0),{user:a}=S(),l=R();x.useEffect(()=>{a?h():l("/auth")},[a]),x.useEffect(()=>{if(!a)return;const s=c.channel("realtime-my-courses").on("postgres_changes",{event:"INSERT",schema:"public",table:"course_enrollments",filter:`user_id=eq.${a.id}`},()=>{console.log("‚úÖ Nova matr√≠cula detectada! Atualizando cursos..."),h(),y.success("üéâ Novo curso liberado!")}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"lesson_progress",filter:`user_id=eq.${a.id}`},()=>{console.log("üìö Progresso atualizado!"),h()}).subscribe();return()=>{c.removeChannel(s)}},[a]);const h=async()=>{if(a){p(!0);try{const{data:s,error:d}=await c.from("course_enrollments").select(`
          course_id,
          enrolled_at,
          last_accessed
        `).eq("user_id",a.id);if(d)throw d;if(!s||s.length===0){_([]),p(!1);return}const o=s.map(t=>t.course_id),{data:P}=await c.from("courses").select("id, title, description, instructor_name, thumbnail_url, category").in("id",o),{data:b}=await c.from("lessons").select("id, title, order_number, course_id").in("course_id",o).order("order_number"),D=(b||[]).map(t=>t.id),{data:q}=await c.from("lesson_progress").select("lesson_id, completed").eq("user_id",a.id).in("lesson_id",D).eq("completed",!0),N=new Set((q||[]).map(t=>t.lesson_id)),B=new Map((P||[]).map(t=>[t.id,t])),L=s.map(t=>{const r=B.get(t.course_id);if(!r)return null;const i=(b||[]).filter(u=>u.course_id===t.course_id),m=i.length,v=i.filter(u=>N.has(u.id)).length,M=m>0?Math.round(v/m*100):0;let n=i.find(u=>!N.has(u.id));return!n&&i.length>0&&(n=i[0]),{id:r.id,title:r.title,description:r.description,instructor_name:r.instructor_name,thumbnail_url:r.thumbnail_url,category:r.category,enrolled_at:t.enrolled_at,last_accessed:t.last_accessed,total_lessons:m,completed_lessons:v,progress_percentage:M,next_lesson_id:(n==null?void 0:n.id)||null,next_lesson_title:(n==null?void 0:n.title)||null}}).filter(t=>t!==null).sort((t,r)=>{const i=t.last_accessed||t.enrolled_at,m=r.last_accessed||r.enrolled_at;return new Date(m).getTime()-new Date(i).getTime()});_(L)}catch{y.error("Erro ao carregar seus cursos")}finally{p(!1)}}},E=async(s,d)=>{try{if(d)l(`/curso/${s}/aula/${d}`);else{const{data:o}=await c.from("lessons").select("id").eq("course_id",s).order("order_number").limit(1).single();l(o?`/curso/${s}/aula/${o.id}`:`/curso/${s}`)}}catch(o){console.error("Erro ao continuar curso:",o),l(`/curso/${s}`)}},j=s=>new Date(s).toLocaleDateString("pt-BR",{day:"2-digit",month:"short",year:"numeric"});return k?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(C,{}),e.jsx("main",{className:"pt-20 min-h-[calc(100vh-4rem)] flex items-center justify-center",children:e.jsx(A,{className:"w-8 h-8 animate-spin text-primary"})}),e.jsx(w,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(C,{}),e.jsxs("main",{className:"pt-20 pb-16",children:[e.jsx("section",{className:"py-12 bg-gradient-to-b from-primary/5 to-background",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"max-w-3xl",children:[e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-foreground mb-4",children:"Meus Cursos"}),e.jsx("p",{className:"text-lg text-muted-foreground mb-6",children:"Continue de onde parou e acompanhe seu progresso"}),e.jsx(z,{})]})})}),e.jsx("section",{className:"py-12",children:e.jsx("div",{className:"container mx-auto px-4",children:f.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-6",children:e.jsx($,{className:"w-12 h-12 text-primary"})}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mb-3",children:"Voc√™ ainda n√£o est√° matriculado em nenhum curso"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto mb-6",children:"Explore nossa biblioteca e comece a aprender hoje mesmo!"}),e.jsx(g,{onClick:()=>l("/cursos"),children:"Ver Cursos Dispon√≠veis"})]}):e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6",children:f.map(s=>e.jsxs(T,{className:"overflow-hidden hover:shadow-lg transition-all duration-300",children:[e.jsxs("div",{className:"h-48 bg-gradient-card flex items-center justify-center bg-cover bg-center relative",style:s.thumbnail_url?{backgroundImage:`url(${s.thumbnail_url})`}:{},children:[!s.thumbnail_url&&e.jsx($,{className:"w-16 h-16 text-primary/30"}),s.progress_percentage===100&&e.jsxs("div",{className:"absolute top-4 right-4 bg-accent text-accent-foreground px-3 py-1 rounded-full flex items-center gap-1 text-sm font-semibold shadow-lg",children:[e.jsx(H,{className:"w-4 h-4"}),"Conclu√≠do"]})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-3",children:[e.jsx("span",{className:"font-medium",children:s.instructor_name}),s.category&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"‚Ä¢"}),e.jsx("span",{className:"text-xs bg-muted px-2 py-1 rounded",children:s.category})]})]}),e.jsx("h3",{className:"text-xl font-bold text-foreground mb-2 line-clamp-2",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4 line-clamp-2",children:s.description||"Sem descri√ß√£o dispon√≠vel"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:"Progresso"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[s.completed_lessons,"/",s.total_lessons," aulas"]})]}),e.jsx(F,{value:s.progress_percentage,className:"h-2"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.progress_percentage,"% conclu√≠do"]})]}),s.next_lesson_title&&s.progress_percentage<100&&e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 mb-4",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Pr√≥xima aula:"}),e.jsx("p",{className:"text-sm font-medium text-foreground line-clamp-1",children:s.next_lesson_title})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-4",children:[e.jsx(O,{className:"w-3 h-3"}),e.jsx("span",{children:s.last_accessed?`√öltimo acesso: ${j(s.last_accessed)}`:`Matriculado em: ${j(s.enrolled_at)}`})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{className:"flex-1",onClick:()=>E(s.id,s.next_lesson_id),children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),s.progress_percentage===0?"Come√ßar":"Continuar"]}),e.jsx(g,{variant:"outline",onClick:()=>l(`/curso/${s.id}`),children:"Ver Detalhes"})]})]})]},s.id))})})})]}),e.jsx(w,{})]})};export{Z as default};
