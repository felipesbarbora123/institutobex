import{c as K,r as i,n as Q,s as w,j as e,I as Y,B as S}from"./index-DZwxJa6p.js";import{H as B,F as R,S as Z,M as ee,c as l}from"./Footer-C1KMTEGG.js";import{C as se,b as ae,c as te,d as re,a as ne}from"./card-BXzsGqNW.js";import{T as oe,a as ce,b as y,c as N}from"./tabs-6h0c_Wcz.js";import{F as ie,T as g,a as L,b as o,c as r,d as C,e as t}from"./table-DPHy_kM9.js";import{I as le}from"./input-DDQYHuv2.js";import{L as de}from"./label-D0JfEdvX.js";import{R as me}from"./refresh-cw-GX1sFyo7.js";import{D as xe}from"./download-CPOnxjoA.js";import{C as he}from"./credit-card-f014Go6m.js";import{f as ue,p as je}from"./pt-BR-COO1Bk_c.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=K("Webhook",[["path",{d:"M18 16.98h-5.99c-1.1 0-1.95.94-2.48 1.9A4 4 0 0 1 2 17c.01-.7.2-1.4.57-2",key:"q3hayz"}],["path",{d:"m6 17 3.13-5.78c.53-.97.1-2.18-.5-3.1a4 4 0 1 1 6.89-4.06",key:"1go1hn"}],["path",{d:"m12 6 3.13 5.73C15.66 12.7 16.9 13 18 13a4 4 0 0 1 0 8",key:"qlwsc0"}]]);function Te(){const[m,I]=i.useState([]),[x,M]=i.useState([]),[h,P]=i.useState([]),[A,_]=i.useState(!0),[n,D]=i.useState(""),[k,H]=i.useState("payments"),{toast:u}=Q();i.useEffect(()=>{T()},[]);const T=async()=>{_(!0);try{await Promise.all([F(),W(),z()])}catch(s){console.error("Erro ao carregar logs:",s),u({title:"Erro ao carregar logs",description:"Não foi possível carregar os logs.",variant:"destructive"})}finally{_(!1)}},F=async()=>{const{data:s,error:a}=await w.from("course_purchases").select("*").order("created_at",{ascending:!1}).limit(100);if(a){console.error("Erro ao buscar logs de pagamento:",a);return}I(s||[])},W=async()=>{const{data:s,error:a}=await w.from("webhook_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(a){console.error("Erro ao buscar logs de webhook:",a);return}M(s||[])},z=async()=>{const{data:s,error:a}=await w.from("email_logs").select("*").order("created_at",{ascending:!1}).limit(100);if(a){console.error("Erro ao buscar logs de email:",a);return}P(s||[])},O=s=>{const c={pending:{variant:"secondary",label:"Pendente"},approved:{variant:"default",label:"Aprovado"},rejected:{variant:"destructive",label:"Rejeitado"},cancelled:{variant:"outline",label:"Cancelado"}}[s]||{variant:"outline",label:s};return e.jsx(l,{variant:c.variant,children:c.label})},V=s=>{const c={sent:{variant:"default",label:"Enviado"},pending:{variant:"secondary",label:"Pendente"},failed:{variant:"destructive",label:"Falhou"}}[s]||{variant:"outline",label:s};return e.jsx(l,{variant:c.variant,children:c.label})},j=()=>n?m.filter(s=>{var a;return s.id.toLowerCase().includes(n.toLowerCase())||s.payment_status.toLowerCase().includes(n.toLowerCase())||((a=s.metadata)==null?void 0:a.externalId)&&s.metadata.externalId.toLowerCase().includes(n.toLowerCase())}):m,p=()=>n?x.filter(s=>s.event_type.toLowerCase().includes(n.toLowerCase())||s.id.toLowerCase().includes(n.toLowerCase())):x,f=()=>n?h.filter(s=>s.recipient_email.toLowerCase().includes(n.toLowerCase())||s.email_type.toLowerCase().includes(n.toLowerCase())||s.subject.toLowerCase().includes(n.toLowerCase())):h,d=s=>{try{return ue(new Date(s),"dd/MM/yyyy HH:mm:ss",{locale:je})}catch{return s}},U=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s),q=()=>{let s=[],a="";switch(k){case"payments":s=j(),a="pagamentos.csv";break;case"webhooks":s=p(),a="webhooks.csv";break;case"emails":s=f(),a="emails.csv";break}if(s.length===0){u({title:"Nenhum dado para exportar",description:"Não há registros para exportar.",variant:"destructive"});return}const c=Object.keys(s[0]).join(","),J=s.map(G=>Object.values(G).map(v=>typeof v=="object"?JSON.stringify(v):v).join(",")),X=[c,...J].join(`
`),$=new Blob([X],{type:"text/csv"}),E=window.URL.createObjectURL($),b=document.createElement("a");b.href=E,b.download=a,b.click(),window.URL.revokeObjectURL(E),u({title:"Exportação concluída",description:`Arquivo ${a} baixado com sucesso.`})};return A?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(B,{}),e.jsx("main",{className:"flex-1 flex items-center justify-center",children:e.jsx(Y,{})}),e.jsx(R,{})]}):e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(B,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Logs do Sistema"}),e.jsx("p",{className:"text-muted-foreground",children:"Visualize e monitore todos os logs de pagamentos, webhooks e emails"})]}),e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),"Logs do Sistema"]}),e.jsx(re,{children:"Últimos 100 registros de cada categoria"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(S,{variant:"outline",size:"sm",onClick:T,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Atualizar"]}),e.jsxs(S,{variant:"outline",size:"sm",onClick:q,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Exportar CSV"]})]})]})}),e.jsxs(ne,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx(de,{htmlFor:"search",children:"Buscar"}),e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(le,{id:"search",placeholder:"Buscar por ID, email, status...",value:n,onChange:s=>D(s.target.value),className:"pl-10"})]})]}),e.jsxs(oe,{value:k,onValueChange:H,children:[e.jsxs(ce,{className:"grid w-full grid-cols-3",children:[e.jsxs(y,{value:"payments",className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Pagamentos (",m.length,")"]}),e.jsxs(y,{value:"webhooks",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Webhooks (",x.length,")"]}),e.jsxs(y,{value:"emails",className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Emails (",h.length,")"]})]}),e.jsx(N,{value:"payments",className:"mt-4",children:e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(g,{children:[e.jsx(L,{children:e.jsxs(o,{children:[e.jsx(r,{children:"ID Externo"}),e.jsx(r,{children:"Valor"}),e.jsx(r,{children:"Método"}),e.jsx(r,{children:"Status"}),e.jsx(r,{children:"Criado"}),e.jsx(r,{children:"Aprovado"})]})}),e.jsx(C,{children:j().length===0?e.jsx(o,{children:e.jsx(t,{colSpan:6,className:"text-center text-muted-foreground",children:"Nenhum log de pagamento encontrado"})}):j().map(s=>{var a;return e.jsxs(o,{children:[e.jsx(t,{className:"font-mono text-xs",children:((a=s.metadata)==null?void 0:a.externalId)||s.id.slice(0,8)}),e.jsx(t,{children:U(Number(s.amount))}),e.jsx(t,{children:e.jsx(l,{variant:"outline",children:s.payment_method==="pix"?"PIX":s.payment_method==="card"?"Cartão":s.payment_method||"N/A"})}),e.jsx(t,{children:O(s.payment_status)}),e.jsx(t,{className:"text-xs",children:d(s.created_at)}),e.jsx(t,{className:"text-xs",children:s.approved_at?d(s.approved_at):"-"})]},s.id)})})]})})}),e.jsx(N,{value:"webhooks",className:"mt-4",children:e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(g,{children:[e.jsx(L,{children:e.jsxs(o,{children:[e.jsx(r,{children:"Evento"}),e.jsx(r,{children:"Status HTTP"}),e.jsx(r,{children:"Erro"}),e.jsx(r,{children:"Criado"})]})}),e.jsx(C,{children:p().length===0?e.jsx(o,{children:e.jsx(t,{colSpan:4,className:"text-center text-muted-foreground",children:"Nenhum log de webhook encontrado"})}):p().map(s=>e.jsxs(o,{children:[e.jsx(t,{children:e.jsx(l,{variant:"secondary",children:s.event_type})}),e.jsx(t,{children:s.response_status?e.jsx(l,{variant:s.response_status>=200&&s.response_status<300?"default":"destructive",children:s.response_status}):"-"}),e.jsx(t,{className:"max-w-xs truncate text-xs",children:s.error_message||"-"}),e.jsx(t,{className:"text-xs",children:d(s.created_at)})]},s.id))})]})})}),e.jsx(N,{value:"emails",className:"mt-4",children:e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(g,{children:[e.jsx(L,{children:e.jsxs(o,{children:[e.jsx(r,{children:"Tipo"}),e.jsx(r,{children:"Destinatário"}),e.jsx(r,{children:"Assunto"}),e.jsx(r,{children:"Status"}),e.jsx(r,{children:"Enviado"}),e.jsx(r,{children:"Erro"})]})}),e.jsx(C,{children:f().length===0?e.jsx(o,{children:e.jsx(t,{colSpan:6,className:"text-center text-muted-foreground",children:"Nenhum log de email encontrado"})}):f().map(s=>e.jsxs(o,{children:[e.jsx(t,{children:e.jsx(l,{variant:"secondary",children:s.email_type==="welcome"?"Boas-vindas":s.email_type==="payment_confirmed"?"Pagamento":s.email_type==="enrollment"?"Matrícula":s.email_type==="certificate"?"Certificado":s.email_type})}),e.jsx(t,{className:"font-mono text-xs",children:s.recipient_email}),e.jsx(t,{className:"max-w-xs truncate",children:s.subject}),e.jsx(t,{children:V(s.status)}),e.jsx(t,{className:"text-xs",children:s.sent_at?d(s.sent_at):"-"}),e.jsx(t,{className:"max-w-xs truncate text-xs text-destructive",children:s.error_message||"-"})]},s.id))})]})})})]})]})]})]}),e.jsx(R,{})]})}export{Te as default};
