import{c as je,o as Je,u as Ze,l as We,n as et,m as tt,r as n,s as h,j as e,L,B as v}from"./index-DZwxJa6p.js";import{H as xe,F as ge,D as Pe,d as Ie,e as Se,f as ke,g as at}from"./Footer-C1KMTEGG.js";import{I as M}from"./input-DDQYHuv2.js";import{L as z}from"./label-D0JfEdvX.js";import{C as W,b as he,c as fe,d as Ee,a as ee}from"./card-BXzsGqNW.js";import{C as te}from"./circle-check-ByrmEm5X.js";import{C as $e}from"./credit-card-f014Go6m.js";import{L as Re}from"./lock-BqV1AFS9.js";import{C as st}from"./chevron-up-D0sK4MUF.js";import{C as ot}from"./chevron-down-BMPktge0.js";import{I as rt}from"./info-CsXgtKWT.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=je("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=je("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=je("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]),it=o=>o.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2"),lt=o=>o.replace(/\D/g,"").slice(0,11).replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2"),Te=o=>{const d=o.replace(/\D/g,"");if(d.length!==11||/^(\d)\1+$/.test(d))return!1;let r=0;for(let m=0;m<9;m++)r+=parseInt(d.charAt(m))*(10-m);let s=11-r%11;if((s===10||s===11)&&(s=0),s!==parseInt(d.charAt(9)))return!1;r=0;for(let m=0;m<10;m++)r+=parseInt(d.charAt(m))*(11-m);return s=11-r%11,(s===10||s===11)&&(s=0),s===parseInt(d.charAt(10))},ct=o=>{const d=o.replace(/\D/g,"");if(d.length!==11)return!1;const r=parseInt(d.substring(0,2));return!(r<11||r>99||d.charAt(2)!=="9")},dt=o=>o.replace(/\D/g,""),mt=o=>o.replace(/\D/g,""),pt=o=>{const d=o.replace(/\D/g,"");return d.length===0?null:d.length<11?"CPF incompleto. Digite 11 d√≠gitos.":/^(\d)\1+$/.test(d)?"CPF inv√°lido. Todos os d√≠gitos s√£o iguais.":Te(o)?null:"CPF inv√°lido. Verifique o n√∫mero digitado."},ut=o=>{const d=o.replace(/\D/g,"");if(d.length===0)return null;if(d.length<11)return"Telefone incompleto. Use o formato (XX) 9XXXX-XXXX.";const r=parseInt(d.substring(0,2));return r<11||r>99?"DDD inv√°lido.":d.charAt(2)!=="9"?"N√∫mero deve ser celular (come√ßar com 9).":null},kt=()=>{const{courseId:o}=Je(),d=Ze();We();const{toast:r}=et(),{user:s}=tt(),[m,Fe]=n.useState(null),[P,_e]=n.useState([]),[Me,Ae]=n.useState(!0),[R,A]=n.useState(!1),[X,D]=n.useState(!1),[Xe,T]=n.useState(!1),[i,se]=n.useState(null),[xt,gt]=n.useState(""),[N,qe]=n.useState([]),[p,y]=n.useState(null),[ht,F]=n.useState(!1),[B,oe]=n.useState(!1),[Oe,K]=n.useState(0),[be,ve]=n.useState(0),[Qe,q]=n.useState(!1),[Ne,re]=n.useState(0),[j,C]=n.useState("idle"),V=n.useRef(!1),b=n.useRef(null),[l,O]=n.useState({name:"",cpf:"",phone:"",email:"",password:""}),[Y,Ue]=n.useState(null),[H,Le]=n.useState(null),[ye,ze]=n.useState(!1),[Ce,Be]=n.useState(!1),[I,J]=n.useState(""),[w,ne]=n.useState(!1),[_,ie]=n.useState(0),[le,we]=n.useState(!1),[ce,de]=n.useState(!1);n.useEffect(()=>{(async()=>{if(!o){r({title:"Erro",description:"Curso n√£o encontrado",variant:"destructive"}),d("/cursos");return}try{if(s){const{data:u}=await h.from("course_enrollments").select("id").eq("user_id",s.id).eq("course_id",o).maybeSingle();if(u){console.log("‚úÖ Usu√°rio j√° tem acesso ao curso, redirecionando..."),r({title:"Voc√™ j√° tem acesso a este curso!",description:"Redirecionando..."}),d(`/curso/${o}`);return}}const{data:a,error:c}=await h.from("courses").select("*").eq("id",o).maybeSingle();if(c)throw c;if(!a)throw new Error("Curso n√£o encontrado");Fe(a);let f=h.from("courses").select("*").eq("category",a.category).neq("id",o);if(s){const{data:u}=await h.from("course_enrollments").select("course_id").eq("user_id",s.id),{data:Q}=await h.from("course_purchases").select("course_id").eq("user_id",s.id).in("payment_status",["approved","paid","active"]),k=(u==null?void 0:u.map($=>$.course_id))||[],E=(Q==null?void 0:Q.map($=>$.course_id))||[],pe=[...new Set([...k,...E])];if(pe.length>0){const $=`(${pe.map(U=>`"${U}"`).join(",")})`;f=f.not("id","in",$)}}const{data:x}=await f.limit(3);_e(x||[]),s!=null&&s.email&&O(u=>({...u,email:s.email}))}catch(a){console.error("Erro ao carregar dados:",a),r({title:"Erro ao carregar dados",description:a.message,variant:"destructive"}),d("/cursos")}finally{Ae(!1)}})()},[o,s,d,r]),n.useEffect(()=>()=>{Z()},[]),n.useEffect(()=>{i==="card"?de(!0):i==="pix"&&(de(!1),(w||I.trim())&&(ne(!1),ie(0),J(""),r({title:"‚ùå Cupom removido",description:"Cupons s√£o v√°lidos apenas para pagamento com cart√£o.",variant:"destructive"})))},[i]);const Ve=t=>{qe(a=>a.includes(t)?a.filter(c=>c!==t):[...a,t])},Ye=async()=>{if(!I.trim()){r({title:"‚ùå Digite um cupom",variant:"destructive"});return}we(!0);try{const{data:t,error:a}=await h.functions.invoke("validate-coupon",{body:{code:I}});a||!t.valid?(r({title:"‚ùå Cupom inv√°lido ou expirado",description:"Verifique o c√≥digo e tente novamente.",variant:"destructive"}),ne(!1),ie(0)):(r({title:"‚úÖ Cupom aplicado com sucesso! üéâ",description:`${t.discountPercent}% de desconto (v√°lido apenas para cart√£o)`,className:"bg-green-600 text-white border-green-700"}),ne(!0),ie(t.discountPercent),t.code?J(String(t.code).toUpperCase()):J(I.toUpperCase()))}catch{r({title:"‚ùå Erro ao validar cupom",description:"Tente novamente mais tarde.",variant:"destructive"})}finally{we(!1)}},S=()=>{let t=(m==null?void 0:m.price)||0;return P.forEach(a=>{N.includes(a.id)&&(t+=a.price)}),w&&_>0&&i==="card"&&(t=t-t*_/100),t},me=async t=>{var f;if(R){console.log("‚ö†Ô∏è [PAYMENT] J√° est√° processando, ignorando...");return}const a=t||i;if(!a){console.error("‚ùå [PAYMENT] M√©todo n√£o selecionado!"),console.error("‚ùå [PAYMENT] Estado atual do selectedMethod:",i),console.error("‚ùå [PAYMENT] Par√¢metro method:",t),r({title:"Erro",description:"M√©todo de pagamento n√£o selecionado.",variant:"destructive"});return}console.log(`‚úÖ [PAYMENT] M√©todo confirmado: ${a}`),console.log(`üîç [PAYMENT] Iniciando processamento para m√©todo: ${a.toUpperCase()}`);const c=a==="pix";if(!l.name||!l.cpf){console.error("‚ùå [PAYMENT] Nome ou CPF faltando"),r({title:"Dados incompletos",description:"Por favor, preencha Nome e CPF.",variant:"destructive"}),A(!1);return}if(!Te(l.cpf)){console.error("‚ùå [PAYMENT] CPF inv√°lido detectado:",l.cpf),r({title:"‚ö†Ô∏è CPF inv√°lido",description:Y||"Por favor, corrija o CPF antes de continuar.",variant:"destructive"}),A(!1);return}if((c||!s)&&(!l.email||!l.phone)){console.error("‚ùå [PAYMENT] Email ou telefone faltando para PIX/novo usu√°rio"),r({title:"Dados incompletos",description:"Por favor, preencha todos os campos obrigat√≥rios.",variant:"destructive"}),A(!1);return}if((c||!s)&&!ct(l.phone)){console.error("‚ùå [PAYMENT] Telefone inv√°lido detectado:",l.phone),r({title:"‚ö†Ô∏è Telefone inv√°lido",description:H||"Por favor, corrija o telefone antes de continuar. Use o formato (XX) 9XXXX-XXXX.",variant:"destructive"}),A(!1);return}A(!0),q(!1),re(0),console.log(`üöÄ [PAYMENT] Iniciando processamento do pagamento com m√©todo: ${a}`);try{const x=l.phone?l.phone.replace(/\D/g,""):"",u=l.cpf.replace(/\D/g,""),Q=(f=l.email)==null?void 0:f.replace(/[^a-zA-Z0-9@._-]/g,"_"),k=P.filter(G=>N.includes(G.id)).map(G=>({id:G.id,title:G.title,price:G.price}));if(console.log(`üéÅ Order bumps selecionados: ${k.length}`,k),(c||!s)&&x.length<10)throw new Error("Telefone inv√°lido");if(u.length!==11)throw new Error("CPF deve ter 11 d√≠gitos");const E=`CURSO${Date.now()}${Math.random().toString(36).substr(2,9)}`.toUpperCase();localStorage.setItem("lastPaymentMethod",a),localStorage.setItem("lastExternalId",E),localStorage.setItem("lastCourseId",o||"");const{data:pe,error:$}=await h.functions.invoke("create-purchase",{body:{userId:(s==null?void 0:s.id)||`temp_${l.email.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}`,courseId:o,amount:S(),externalId:E,paymentMethod:a,customerData:{name:l.name,email:l.email,phone:x,taxId:u},orderBumps:k}});if($)throw $;const U=a==="pix"?"create-payment-pix":"create-payment-card";a==="pix"&&(D(!0),C("generating"),F(!1),oe(!1),ve(0),q(!1),re(0)),console.log(`üîÑ [${new Date().toISOString()}] M√©todo selecionado no momento: ${a}`),console.log(`üìû [${new Date().toISOString()}] Fun√ß√£o que ser√° chamada: ${U}`),console.log(`üéØ [${new Date().toISOString()}] Confirmando - √â PIX? ${a==="pix"} | √â CART√ÉO? ${a==="card"}`);const{data:g,error:ue}=await h.functions.invoke(U,{body:{externalId:E,courseId:o,userId:(s==null?void 0:s.id)||`temp_${l.email||l.cpf}`,amount:S(),email:l.email||(s==null?void 0:s.email)||`${u}@temp.dunis.com.br`,name:l.name,phone:x||"0000000000",taxId:u,appOrigin:window.location.origin,orderBumps:k,...a==="card"&&w&&{allowCoupons:!0,coupons:[I]}}});if(ue)throw console.error(`‚ùå Erro ao chamar ${U}:`,ue),ue;if(console.log(`‚úÖ Resposta de ${U}:`,JSON.stringify(g,null,2)),a==="card"){if(console.log("üí≥ [PAYMENT] Processando resposta do CART√ÉO"),!g||!(g.data||g).payment_url)throw console.error("‚ùå [PAYMENT] payment_url n√£o encontrado na resposta:",g),new Error("URL de pagamento n√£o foi retornada");const cardData=g.data||g;console.log("üîó [PAYMENT] URL de pagamento:",cardData.payment_url),r({title:"Redirecionando...",description:"Voc√™ ser√° direcionado para finalizar o pagamento."}),console.log("üöÄ [PAYMENT] Redirecionando para:",cardData.payment_url),window.location.href=cardData.payment_url}else if(a==="pix"){if(console.log("‚ö° Processando resposta do PIX"),!g||!(g.data||g).qr_code||!(g.data||g).copia_cola)throw console.error("‚ùå QR Code ou copia_cola n√£o encontrado na resposta:",g),C("idle"),new Error("Dados do PIX n√£o foram retornados");const pixData=g.data||g;console.log("üì± QR Code recebido, exibindo..."),y({qr_code:pixData.qr_code,copia_cola:pixData.copia_cola,externalId:E,billingId:pixData.billingId||pixData.id}),C("displaying"),(pixData.billingId||pixData.id)&&localStorage.setItem("lastBillingId",pixData.billingId||pixData.id),r({title:"‚úÖ QR Code gerado!",description:"Escaneie o QR Code ou copie o c√≥digo para pagar."})}else throw console.error("‚ùå M√©todo desconhecido ou resposta inv√°lida"),new Error("Erro ao processar pagamento")}catch(x){console.error("Erro no checkout:",x),a==="pix"&&(D(!1),y(null),q(!0),C("idle")),r({title:"Erro no pagamento",description:x.message||"N√£o foi poss√≠vel processar o pagamento",variant:"destructive"})}finally{A(!1)}},He=async t=>{if(t.preventDefault(),console.log("üìù [CHECKOUT] handleSubmit chamado"),console.log("üí∞ [CHECKOUT] M√©todo selecionado atual:",i),!i){console.log("‚ö†Ô∏è [CHECKOUT] Nenhum m√©todo selecionado ‚Üí abrindo modal de escolha"),T(!0);return}console.log(`üöÄ [CHECKOUT] Processando pagamento com m√©todo: ${i}`),await me()},Ge=t=>{let a=0;const c=60;V.current=!0;const f=async()=>{try{if(!V.current||!X){F(!1),b.current&&(clearTimeout(b.current),b.current=null);return}F(!0),a++,console.log(`üîÑ [${new Date().toISOString()}] Verificando pagamento (PIX) - tentativa ${a}/${c}`);const x=(p==null?void 0:p.billingId)||localStorage.getItem("lastBillingId");if(x)try{const{data:u,error:Q}=await h.functions.invoke("abacatepay-check-status",{body:{billingId:x}});if(!Q&&(u!=null&&u.success)&&(console.log("üìä Status (gateway):",u.status),u.status==="PAID"||u.status==="APPROVED")){console.log("‚úÖ Status PAID/APPROVED detectado, confirmando compra...");const{data:k,error:E}=await h.functions.invoke("confirm-purchase",{body:{externalId:t,billingId:x}});console.log("‚úÖ Resposta confirm-purchase:",k,E);if(!E&&(k!=null&&k.success||k!=null&&k.purchase)){console.log("‚úÖ Pagamento confirmado com sucesso! Exibindo mensagem..."),V.current=!1,b.current&&(clearTimeout(b.current),b.current=null),localStorage.removeItem("lastPaymentMethod"),localStorage.removeItem("lastExternalId"),localStorage.removeItem("lastCourseId"),localStorage.removeItem("lastBillingId"),D(!1),y(null),F(!1),C("verifying"),r({title:"‚úÖ Pagamento aprovado! üéâ",description:"Seu curso foi liberado. Redirecionando...",className:"bg-green-600 text-white border-green-700"}),setTimeout(()=>{d(`/curso/${o}`,{replace:!0})},1200);return}}}catch(u){console.warn("‚ö†Ô∏è Falha ao consultar gateway, usando fallback DB:",u)}if(s&&o){const{data:u}=await h.from("course_enrollments").select("id").eq("user_id",s.id).eq("course_id",o).maybeSingle();if(u){console.log("‚úÖ Pagamento confirmado e matr√≠cula encontrada!"),V.current=!1,b.current&&(clearTimeout(b.current),b.current=null),localStorage.removeItem("lastPaymentMethod"),localStorage.removeItem("lastExternalId"),localStorage.removeItem("lastCourseId"),localStorage.removeItem("lastBillingId"),D(!1),y(null),F(!1),r({title:"‚úÖ Pagamento aprovado! üéâ",description:"Seu curso foi liberado. Redirecionando...",className:"bg-green-600 text-white border-green-700"}),setTimeout(()=>{d(`/curso/${o}`,{replace:!0})},1200);return}}a<c?b.current=window.setTimeout(f,3e3):(V.current=!1,F(!1),r({title:"Aguardando confirma√ß√£o",description:"O pagamento pode demorar alguns minutos. Voc√™ ser√° notificado assim que for confirmado."}))}catch(x){console.error("Erro ao verificar pagamento:",x),b.current=window.setTimeout(f,3e3)}};b.current=window.setTimeout(f,5e3)},Z=()=>{V.current=!1,b.current&&(clearTimeout(b.current),b.current=null),F(!1)};n.useEffect(()=>{if(!p||!s||!o)return;console.log("üì° [REALTIME] Inscrevendo para confirmar pagamento PIX via realtime");const t=h.channel(`pix_payment_${s.id}_${o}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"course_enrollments",filter:`user_id=eq.${s.id}`},a=>{var c;((c=a==null?void 0:a.new)==null?void 0:c.course_id)===o&&(console.log("‚úÖ [REALTIME] Pagamento confirmado! Liberando curso..."),C("verifying"),localStorage.removeItem("lastPaymentMethod"),localStorage.removeItem("lastExternalId"),localStorage.removeItem("lastCourseId"),r({title:"‚úÖ Pagamento aprovado! üéâ",description:"Seu curso foi liberado. Redirecionando...",className:"bg-green-600 text-white border-green-700"}),setTimeout(()=>{d(`/curso/${o}`,{replace:!0})},1500))}).subscribe();return()=>{h.removeChannel(t)}},[p,s,o,d,r]),n.useEffect(()=>{if(j!=="displaying"||!B||!p)return;console.log("‚è±Ô∏è Iniciando fallback polling em 30 segundos...");const t=setTimeout(()=>{console.log("üîÑ Iniciando verifica√ß√£o de fallback ap√≥s 30s"),Ge(p.externalId)},3e4);return()=>clearTimeout(t)},[j,B,p]),n.useEffect(()=>{if(!X||i!=="pix"||p)return;let t=0;const a=setInterval(()=>{t++,re(t),t>=15&&!p&&(console.error("‚è±Ô∏è Timeout: QR Code n√£o foi gerado em 15 segundos"),q(!0),clearInterval(a))},1e3);return()=>clearInterval(a)},[X,i,p]);const Ke=async()=>{if(!(!p||!o)){if(be>=2){console.warn("‚ö†Ô∏è Limite de tentativas de regenera√ß√£o atingido"),K(t=>t+1);return}try{ve(x=>x+1),oe(!1);const t=(l.phone||"").replace(/\D/g,"")||"0000000000",a=(l.cpf||"").replace(/\D/g,"");console.log(`üîÑ Regenerando QR Code (tentativa ${be+1}/2)`);const{data:c,error:f}=await h.functions.invoke("create-payment-pix",{body:{externalId:p.externalId,courseId:o,userId:(s==null?void 0:s.id)||`temp_${l.email||l.cpf}`,amount:S(),email:l.email||(s==null?void 0:s.email)||`${a}@temp.dunis.com.br`,name:l.name,phone:t,taxId:a}});const pixDataRegen=(c==null?void 0:c.data)||c;!f&&pixDataRegen&&(pixDataRegen.qr_code)&&(pixDataRegen.copia_cola)?(console.log("‚úÖ QR Code regenerado com sucesso"),y({qr_code:pixDataRegen.qr_code,copia_cola:pixDataRegen.copia_cola,externalId:p.externalId,billingId:pixDataRegen.billingId||pixDataRegen.id||p.billingId}),(pixDataRegen.billingId||pixDataRegen.id)&&localStorage.setItem("lastBillingId",pixDataRegen.billingId||pixDataRegen.id),K(x=>x+1)):(console.error("‚ùå Falha na regenera√ß√£o do QR:",f||c),K(x=>x+1))}catch(t){console.error("‚ùå Erro ao regerar QR:",t),K(a=>a+1)}}};return n.useEffect(()=>{if(X&&i==="pix"&&p&&!B){const t=setTimeout(()=>{console.warn("‚è±Ô∏è Timeout de 3s: regenerando QR Code via backend"),Ke()},3e3);return()=>clearTimeout(t)}},[X,i,p,B]),Me?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(xe,{}),e.jsx("div",{className:"container mx-auto px-4 py-20 flex justify-center",children:e.jsx(L,{className:"h-8 w-8 animate-spin"})}),e.jsx(ge,{})]}):m?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(xe,{}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Finalizar Compra"}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(W,{children:[e.jsxs(he,{children:[e.jsx(fe,{children:"Informa√ß√µes Pessoais"}),e.jsx(Ee,{children:"Preencha seus dados para continuar"})]}),e.jsx(ee,{children:e.jsxs("form",{onSubmit:He,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"name",children:"Nome completo *"}),e.jsx(M,{id:"name",type:"text",placeholder:"Seu nome completo",value:l.name,onChange:t=>O({...l,name:t.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"cpf",children:"CPF *"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"cpf",type:"text",placeholder:"000.000.000-00",value:l.cpf,onChange:t=>{const a=it(t.target.value);O({...l,cpf:a});const c=pt(a);Ue(c),ze(!c&&dt(a).length===11)},maxLength:14,className:Y?"border-destructive":ye?"border-green-500":"",required:!0}),ye&&e.jsx(te,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-green-500"}),Y&&e.jsx(ae,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-destructive"})]}),Y&&e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),Y]})]}),(!i||i==="pix")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"phone",children:"Celular *"}),e.jsxs("div",{className:"relative",children:[e.jsx(M,{id:"phone",type:"tel",placeholder:"(00) 00000-0000",value:l.phone,onChange:t=>{const a=lt(t.target.value);O({...l,phone:a});const c=ut(a);Le(c),Be(!c&&mt(a).length===11)},maxLength:15,className:H?"border-destructive":Ce?"border-green-500":"",required:!i||i==="pix"}),Ce&&e.jsx(te,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-green-500"}),H&&e.jsx(ae,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-destructive"})]}),H&&e.jsxs("p",{className:"text-sm text-destructive flex items-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),H]})]}),(!i||i==="pix"||!s)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"email",children:"E-mail *"}),e.jsx(M,{id:"email",type:"email",placeholder:"seu@email.com",value:l.email,onChange:t=>O({...l,email:t.target.value}),required:!i||i==="pix"||!s})]}),!s&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"password",children:"Criar senha *"}),e.jsx(M,{id:"password",type:"password",placeholder:"M√≠nimo 6 caracteres",value:l.password,onChange:t=>O({...l,password:t.target.value}),minLength:6,required:!0})]}),e.jsx(W,{className:"bg-muted/50 mt-6",children:e.jsx(ee,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[m.thumbnail_url&&e.jsx("img",{src:m.thumbnail_url,alt:m.title,className:"w-24 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold",children:m.title}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["R$ ",m.price.toFixed(2)]})]})]})})}),e.jsx(v,{type:"submit",className:`w-full text-white mt-6 transition-colors ${i==="pix"?"bg-green-600 hover:bg-green-700":i==="card"?"bg-blue-600 hover:bg-blue-700":"bg-primary hover:bg-primary/90"}`,size:"lg",disabled:R,children:R?e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"mr-2 h-4 w-4 animate-spin"}),i==="pix"?"Gerando PIX...":i==="card"?"Gerando pagamento...":"Processando..."]}):e.jsx(e.Fragment,{children:i==="pix"?e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"mr-2 h-5 w-5"}),"‚ö° Finalizar com PIX - R$ ",S().toFixed(2)]}):i==="card"?e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"mr-2 h-5 w-5"}),"üí≥ Finalizar com CART√ÉO - R$ ",S().toFixed(2)]}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"mr-2 h-5 w-5"}),"Avan√ßar"]})})}),i&&e.jsx("div",{className:"text-center mt-2",children:e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>{console.log("üîÑ [CHECKOUT] Usu√°rio clicou em trocar m√©todo"),Z(),se(null),y(null)},className:"text-xs",disabled:R,children:"Trocar forma de pagamento"})}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground mt-4",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx("span",{children:"Pagamento 100% seguro"})]})]})})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(W,{children:[e.jsx(he,{children:e.jsx(fe,{children:"Resumo do Pedido"})}),e.jsx(ee,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Curso principal"}),e.jsxs("span",{className:"font-medium",children:["R$ ",m.price.toFixed(2)]})]}),N.length>0&&e.jsx(e.Fragment,{children:P.filter(t=>N.includes(t.id)).map(t=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["+ ",t.title]}),e.jsxs("span",{className:"font-medium",children:["R$ ",t.price.toFixed(2)]})]},t.id))}),e.jsxs("div",{className:"border-t pt-4 pb-3 space-y-3",children:[e.jsxs("button",{type:"button",onClick:()=>de(!ce),className:"w-full flex items-center justify-between text-left text-sm font-semibold text-primary hover:underline",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"w-4 h-4"}),"üí∏ Cupom de Desconto?"]}),ce?e.jsx(st,{className:"w-4 h-4"}):e.jsx(ot,{className:"w-4 h-4"})]}),ce&&e.jsxs("div",{className:"space-y-2 animate-in fade-in-50 duration-200",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{type:"text",placeholder:"Digite o c√≥digo",value:I,onChange:t=>J(t.target.value.toUpperCase()),className:"flex-1 text-sm",disabled:le||w}),e.jsx(v,{type:"button",size:"sm",onClick:Ye,disabled:le||w||!I.trim(),className:"bg-primary hover:bg-primary/90",children:le?e.jsx(L,{className:"w-4 h-4 animate-spin"}):"Aplicar"})]}),w&&e.jsx("div",{className:"p-2 bg-green-50 dark:bg-green-950/30 border border-green-400 dark:border-green-700 rounded text-center",children:e.jsxs("p",{className:"text-xs text-green-700 dark:text-green-400 font-semibold flex items-center justify-center gap-1",children:[e.jsx(te,{className:"w-4 h-4"}),'‚úÖ Cupom "',I,'" aplicado! ',_,"% de desconto"]})}),e.jsxs("p",{className:"text-xs text-muted-foreground text-center flex items-start gap-1 bg-blue-50 dark:bg-blue-950/20 p-2 rounded border border-blue-200 dark:border-blue-800",children:[e.jsx(rt,{className:"w-3 h-3 mt-0.5 flex-shrink-0"}),"Desconto v√°lido apenas para pagamento com cart√£o"]})]})]}),w&&_>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-t pt-2 flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"font-medium",children:["R$ ",(m.price+P.filter(t=>N.includes(t.id)).reduce((t,a)=>t+a.price,0)).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-green-600 dark:text-green-400 font-medium flex items-center gap-1",children:[e.jsx(te,{className:"w-4 h-4"}),"Desconto (",_,"%)"]}),e.jsxs("span",{className:"text-green-600 dark:text-green-400 font-semibold",children:["- R$ ",(m.price+P.filter(t=>N.includes(t.id)).reduce((t,a)=>t+a.price,0)-S()).toFixed(2)]})]}),i==="pix"&&e.jsx("div",{className:"text-xs text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded p-2 text-center",children:"‚ö†Ô∏è Desconto v√°lido apenas para pagamento com cart√£o"})]}),e.jsxs("div",{className:"border-t pt-3 flex justify-between items-center",children:[e.jsx("span",{className:"font-bold text-lg",children:"Total"}),e.jsxs("span",{className:`font-bold text-xl ${w&&i==="card"&&_>0?"text-green-600 dark:text-green-400":"text-foreground"}`,children:["R$ ",S().toFixed(2)]})]}),w&&i==="card"&&_>0&&e.jsx("div",{className:"bg-green-50 dark:bg-green-950/30 border-2 border-green-400 dark:border-green-700 rounded-lg p-3 text-center",children:e.jsxs("p",{className:"text-green-700 dark:text-green-400 font-bold text-sm flex items-center justify-center gap-2",children:["üéâ Voc√™ economiza R$ ",(m.price+P.filter(t=>N.includes(t.id)).reduce((t,a)=>t+a.price,0)-S()).toFixed(2),"!"]})}),i&&e.jsx("div",{className:"bg-primary/10 border border-primary/20 rounded-lg p-3 mt-4",children:e.jsx("div",{className:"flex items-center gap-2",children:i==="pix"?e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-5 h-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Pagamento via PIX"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Confirma√ß√£o instant√¢nea"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"w-5 h-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Pagamento via Cart√£o"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Parcelamento dispon√≠vel"})]})]})})})]})})]}),P.length>0&&e.jsxs(W,{className:"border-primary/50",children:[e.jsxs(he,{className:"pb-3",children:[e.jsx(fe,{className:"text-lg",children:"üéÅ Aproveite esta oferta!"}),e.jsx(Ee,{children:"Cursos relacionados"})]}),e.jsx(ee,{className:"space-y-3",children:P.map(t=>e.jsx("div",{className:`border rounded-lg p-3 cursor-pointer transition-all ${N.includes(t.id)?"border-primary bg-primary/5":"border-border hover:border-primary/50"}`,onClick:()=>Ve(t.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("input",{type:"checkbox",id:`orderbump-${t.id}`,checked:N.includes(t.id),onChange:()=>{},className:"orderbump-checkbox mt-1 pointer-events-none"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm mb-1",children:t.title}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:t.description}),e.jsxs("p",{className:"text-sm font-bold text-green-600 mt-2",children:["+ R$ ",t.price.toFixed(2)]})]})]})},t.id))})]})]})]})]})}),e.jsx(Pe,{open:Xe,onOpenChange:T,children:e.jsxs(Ie,{className:"sm:max-w-[420px] p-6 flex flex-col justify-center min-h-[400px] rounded-xl",children:[e.jsxs(Se,{className:"space-y-2 text-center sm:text-center",children:[e.jsx(ke,{className:"text-lg font-semibold",children:"Escolha como deseja pagar"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2 mb-4",children:"Selecione abaixo sua forma de pagamento"})]}),e.jsxs("div",{className:"w-full space-y-3",children:[e.jsx(v,{type:"button",onClick:async()=>{console.log("‚úÖ Usu√°rio selecionou: PIX"),se("pix"),y(null),T(!1),C("generating"),await me("pix")},className:"w-full h-auto py-6 text-white",style:{backgroundColor:"#00B050"},disabled:R,children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-xl font-bold",children:[e.jsx("span",{children:"‚ö°"}),e.jsx("span",{children:"PIX"})]}),e.jsx("span",{className:"text-sm opacity-90",children:"Confirma√ß√£o instant√¢nea"})]})}),e.jsx(v,{type:"button",onClick:async()=>{console.log("‚úÖ Usu√°rio selecionado: CART√ÉO"),se("card"),y(null),T(!1),D(!0),await me("card")},className:"w-full h-auto py-6 text-white",style:{backgroundColor:"#007BFF"},disabled:R,children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-xl font-bold",children:[e.jsx("span",{children:"üí≥"}),e.jsx("span",{children:"D√©bito ou Cr√©dito"})]}),e.jsx("span",{className:"text-sm opacity-90",children:"Ser√° redirecionado ao AbacatePay ‚ù§Ô∏è"})]})}),e.jsx(v,{type:"button",onClick:()=>{console.log("‚ùå Usu√°rio cancelou sele√ß√£o de m√©todo"),T(!1)},variant:"outline",className:"w-full mt-4",disabled:R,children:"Voltar"})]})]})}),e.jsx(Pe,{open:X,onOpenChange:t=>{console.log(`üîî Dialog onOpenChange chamado: ${t}`),t||(console.log("‚úÖ Fechando dialog"),Z(),j!=="verifying"&&(localStorage.removeItem("lastPaymentMethod"),localStorage.removeItem("lastExternalId"),localStorage.removeItem("lastCourseId"),localStorage.removeItem("lastBillingId")),D(!1),y(null),F(!1),C("idle"))},children:e.jsx(Ie,{id:"modal-pagamento",className:"w-[95vw] sm:max-w-[520px] max-w-[520px] min-h-[70vh] p-6 flex flex-col items-center justify-center text-center",children:e.jsxs(Se,{children:[e.jsxs(ke,{children:[j==="generating"&&"Gerando QR Code...",j==="displaying"&&"‚ö° PIX",j==="verifying"&&"Verificando pagamento...",j==="idle"&&i==="card"&&"Redirecionando..."]}),e.jsxs(at,{className:"pt-4 text-center",children:[j==="generating"&&e.jsxs("div",{className:"space-y-4 flex flex-col items-center justify-center min-h-[300px]",children:[e.jsx(L,{className:"h-12 w-12 animate-spin text-green-600"}),e.jsx("p",{className:"text-base font-semibold text-green-600",children:"Gerando QR Code, aguarde alguns segundos..."}),Ne>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["(",Ne,"s)"]})]}),j==="displaying"&&p&&e.jsxs("div",{className:"space-y-4 flex flex-col items-center justify-center text-center",children:[e.jsx("p",{className:"text-base mb-1 font-semibold",children:"üì± Escaneie o QR Code abaixo para concluir seu pagamento"}),e.jsx("p",{className:"text-sm text-green-600 font-medium mt-1",children:"‚úÖ Detectaremos o pagamento automaticamente"}),e.jsx("p",{className:"text-sm text-muted-foreground -mt-2 mb-3",children:"ou copie o c√≥digo PIX abaixo"}),e.jsx("div",{className:"bg-white p-4 rounded-lg inline-block mt-2",children:e.jsx("img",{src:p.qr_code.startsWith("data:")?p.qr_code:`data:image/png;base64,${p.qr_code}`,alt:"QR Code PIX",className:"w-[220px] h-[220px] mx-auto",onLoad:()=>{!B&&j==="displaying"&&(console.log("‚úÖ QR Code carregado e pronto para escaneamento"),oe(!0))},onError:()=>{console.warn("‚ö†Ô∏è Falha ao carregar QR Code"),q(!0)}},Oe)}),e.jsxs("div",{className:"space-y-2 mt-3 w-full max-w-[420px]",children:[e.jsx(z,{className:"font-semibold text-sm",children:"C√≥digo PIX (Copia e Cola)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{value:p.copia_cola,readOnly:!0,className:"font-mono text-xs"}),e.jsx(v,{onClick:()=>{navigator.clipboard.writeText(p.copia_cola),r({title:"‚úÖ Copiado!",description:"C√≥digo PIX copiado"})},className:"text-white",style:{backgroundColor:"#00B050"},children:"Copiar"})]})]}),e.jsx(v,{type:"button",onClick:()=>{Z(),y(null),D(!1),T(!0),C("idle")},variant:"outline",className:"mt-4",children:"Trocar forma de pagamento"})]}),j==="verifying"&&e.jsxs("div",{className:"space-y-4 flex flex-col items-center justify-center min-h-[200px]",children:[e.jsx(L,{className:"h-12 w-12 animate-spin text-green-600"}),e.jsx("p",{className:"text-base font-semibold text-green-600",children:"Aguardando confirma√ß√£o do pagamento..."}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Isso pode levar alguns instantes"})]}),Qe&&e.jsxs("div",{className:"space-y-4 flex flex-col items-center justify-center min-h-[200px]",children:[e.jsx("p",{className:"text-base font-semibold text-red-600",children:"‚ùå Erro ao gerar QR Code"}),e.jsx(v,{onClick:()=>{q(!1),C("idle"),D(!1),T(!0)},children:"Tentar novamente"})]}),j==="idle"&&i==="card"&&e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-12 w-12 animate-spin mx-auto mb-4 text-primary"}),e.jsx("p",{className:"text-base",children:"Voc√™ ser√° redirecionado ao AbacatePay para finalizar o pagamento."})]})]})]})})}),e.jsx(ge,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(xe,{}),e.jsxs("div",{className:"container mx-auto px-4 py-20 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Curso n√£o encontrado"}),e.jsx(v,{onClick:()=>d("/cursos"),children:"Ver todos os cursos"})]}),e.jsx(ge,{})]})};export{kt as default};
