import{j as e,B as j,r as m,m as S,s as h,k as o,L as R}from"./index-DZwxJa6p.js";import{A as w,H as _,F as E,D as q,d as M,e as U,f as F,g as O}from"./Footer-C1KMTEGG.js";import{C as B,b as H,c as I,a as T}from"./card-BXzsGqNW.js";import{D as $}from"./download-CPOnxjoA.js";import{E as A}from"./external-link-Bd-dnFeP.js";import{f as G,p as K}from"./pt-BR-COO1Bk_c.js";import{I as P}from"./input-DDQYHuv2.js";import{L as V}from"./label-D0JfEdvX.js";function W({certificate:c,onDownload:l}){const g=G(new Date(c.issued_at),"dd 'de' MMMM 'de' yyyy",{locale:K});return e.jsxs(B,{className:"overflow-hidden hover:shadow-hover transition-all duration-300 border-2 border-primary/20",children:[e.jsx(H,{className:"bg-gradient-hero text-white",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-full flex items-center justify-center",children:e.jsx(w,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx(I,{className:"text-lg",children:c.course_title||"Certificado de Conclusão"}),e.jsxs("p",{className:"text-sm text-white/80 mt-1",children:["Emitido em ",g]})]})]})}),e.jsx(T,{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Código de Verificação"}),e.jsx("p",{className:"font-mono text-lg font-bold text-primary",children:c.certificate_code})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(j,{onClick:()=>l==null?void 0:l(c),className:"flex-1",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Baixar Certificado"]}),e.jsx(j,{variant:"outline",onClick:()=>window.open(`/verificar-certificado/${c.certificate_code}`,"_blank"),children:e.jsx(A,{className:"w-4 h-4"})})]})]})})]})}const se=()=>{const[c,l]=m.useState([]),[g,b]=m.useState(!0),{user:s}=S(),[D,p]=m.useState(!1),[d,C]=m.useState(""),[N,k]=m.useState(null);m.useEffect(()=>{s&&v()},[s]);const v=async()=>{if(s)try{b(!0);const{data:r,error:a}=await h.from("certificates").select("*").eq("user_id",s.id).order("issued_at",{ascending:!1});if(a)throw a;if(r&&r.length>0){const f=r.map(n=>n.course_id),{data:t,error:i}=await h.from("courses").select("id, title").in("id",f);if(!i&&t){const n=new Map(t.map(x=>[x.id,x.title])),u=r.map(x=>({...x,course_title:n.get(x.course_id)}));l(u)}else l(r)}else l([])}catch(r){console.error("Error fetching certificates:",r),o.error("Erro ao carregar certificados")}finally{b(!1)}},L=async r=>{const{data:a,error:f}=await h.from("courses").select("certificate_enabled, certificate_template_url").eq("id",r.course_id).maybeSingle();if(f||!a){o.error("Erro ao verificar configuração do curso");return}if(!a.certificate_enabled){o.error("Certificados não estão habilitados para este curso");return}if(!a.certificate_template_url){o.error("Nenhum template de certificado configurado para este curso. Entre em contato com o suporte.");return}const{data:t}=await h.from("profiles").select("first_name, last_name").eq("id",s==null?void 0:s.id).maybeSingle(),i=t?`${t.first_name||""} ${t.last_name||""}`.trim():"";C(i),k(r),p(!0)},y=async()=>{if(!d.trim()){o.error("Por favor, informe seu nome completo");return}if(N)try{p(!1);let r=N.certificate_url;if(!r){o.success("Gerando certificado, aguarde...");const{data:n,error:u}=await h.functions.invoke("generate-certificate",{body:{course_id:N.course_id,user_id:s==null?void 0:s.id,full_name:d.trim()}});if(u)throw console.error("Error generating certificate:",u),new Error(u.message||"Erro ao gerar certificado");if(!(n!=null&&n.certificate_url))throw new Error("URL do certificado não retornada");r=n.certificate_url,o.success("Certificado gerado com sucesso!"),await v()}const a=await fetch(r);if(!a.ok)throw new Error("Erro ao baixar o arquivo do certificado");const f=await a.blob(),t=window.URL.createObjectURL(f),i=document.createElement("a");i.href=t,i.download=`Certificado - ${d}.pdf`,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(t),o.success("Download iniciado!")}catch(r){console.error("Download error:",r),o.error(r.message||"Erro ao processar certificado")}};return s?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(_,{}),e.jsx("main",{className:"pt-20 pb-16",children:e.jsxs("div",{className:"container mx-auto px-4",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-hero rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(w,{className:"w-10 h-10 text-white"})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold text-foreground mb-4",children:"Meus Certificados"}),e.jsx("p",{className:"text-lg text-muted-foreground max-w-2xl mx-auto",children:"Seus certificados de conclusão de cursos"})]}),g?e.jsx("div",{className:"flex justify-center items-center py-16",children:e.jsx(R,{className:"w-8 h-8 animate-spin text-primary"})}):c.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"w-24 h-24 rounded-full bg-muted flex items-center justify-center mx-auto mb-6",children:e.jsx(w,{className:"w-12 h-12 text-muted-foreground"})}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mb-3",children:"Nenhum certificado ainda"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:"Complete cursos para receber certificados de conclusão."})]}):e.jsx("div",{className:"grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",children:c.map(r=>e.jsx(W,{certificate:r,onDownload:L},r.id))})]})}),e.jsx(E,{}),e.jsx(q,{open:D,onOpenChange:p,children:e.jsxs(M,{children:[e.jsxs(U,{children:[e.jsx(F,{children:"Confirme seu nome completo"}),e.jsx(O,{children:"Este nome será impresso no certificado. Certifique-se de que está correto."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"fullName",children:"Nome completo"}),e.jsx(P,{id:"fullName",placeholder:"Digite seu nome completo",value:d,onChange:r=>C(r.target.value),onKeyDown:r=>{r.key==="Enter"&&d.trim()&&y()}})]})}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(j,{variant:"outline",onClick:()=>p(!1),children:"Cancelar"}),e.jsx(j,{onClick:y,disabled:!d.trim(),children:"Gerar Certificado"})]})]})})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(_,{}),e.jsx("main",{className:"pt-20 pb-16",children:e.jsx("div",{className:"container mx-auto px-4 text-center",children:e.jsx("p",{className:"text-lg text-muted-foreground",children:"Faça login para ver seus certificados"})})}),e.jsx(E,{})]})};export{se as default};
